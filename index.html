<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NORAD Strategic Defense Network</title>

<style>
    body{
        margin:0;
        background:black;
        color:#00ffcc;
        font-family:"Courier New", monospace;
        overflow: hidden;
    }
    header{
        background:#050a12;
        padding:20px;
        text-align:center;
        font-size:26px;
        border-bottom:2px solid #00ffcc;
        position: relative;
        z-index: 2001; 
    }
    .timer{
        font-size:20px;
        color:#ff3333;
    }
    .section{
        display:none;
        padding:20px;
        height: 80vh;
        overflow-y: auto;
        padding-bottom: 100px;
    }
    .cluster{
        border:1px solid #00ffcc;
        padding:15px;
        margin-bottom:20px;
        background:#07131f;
    }
    .formula-box {
        background: #001a00;
        border-left: 4px solid #00ffcc;
        padding: 10px 15px;
        margin: 15px 0;
        font-family: "Times New Roman", Times, serif;
        font-size: 18px;
        color: #ccffcc;
        line-height: 1.6;
    }
    .formula-box i { font-style: italic; }
    
    button{
        background:#001f33;
        color:#00ffcc;
        border:1px solid #00ffcc;
        padding:8px 16px;
        margin-top:10px;
        cursor:pointer;
        font-family: inherit;
        font-weight: bold;
    }
    button:hover{ background:#00334d; }
    input{
        background:black;
        color:#00ffcc;
        border:1px solid #00ffcc;
        padding:6px;
        font-family: inherit;
        width: 300px; 
    }
    .launchInput{
        width:100px;
        text-align:center;
    }
    
    /* OVERRIDE PUZZLES STYLES */
    .override-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 30px;
        margin-top: 20px;
    }
    
    /* Uniform Box Sizing */
    .override-box {
        width: 320px;
        height: 420px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        box-sizing: border-box;
    }

    /* Levers */
    .lever-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
    }
    .lever {
        width: 60px;
        height: 60px;
        font-size: 16px;
        border-radius: 8px;
        transition: 0.2s;
    }
    .lever.up { background: lime; color: black; border-color: lime; box-shadow: 0px -5px 0px 0px #009900 inset; }
    .lever.down { background: red; color: white; border-color: red; box-shadow: 0px 5px 0px 0px #990000 inset; }

    /* Wires */
    .wire-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: #222;
        padding: 20px;
        border: 2px solid #555;
        margin: 20px 0;
        width: 80%;
        align-items: center;
    }
    .wire {
        width: 150px;
        height: 15px;
        cursor: pointer;
        border: 1px solid #000;
        border-radius: 10px;
        box-shadow: 0px 3px 5px rgba(0,0,0,0.5);
    }
    .wire.cut { opacity: 0.1; pointer-events: none; }
    .wire-white { background: #fff; }
    .wire-yellow { background: #ffcc00; }
    .wire-blue { background: #0066ff; }
    .wire-red { background: #cc0000; }

    /* Maze */
    .maze-container {
        background: #000;
        border: 2px solid transparent; 
        padding: 5px;
        display: inline-block;
        margin: 10px;
    }
    .maze-row { display: flex; }
    .maze-cell {
        width: 35px;
        height: 35px;
        box-sizing: border-box;
        border: 1px dotted transparent;
        position: relative;
    }
    .maze-cell::before {
        content: "";
        position: absolute;
        width: 4px; height: 4px;
        background: #444; 
        border-radius: 50%;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
    }
    
    .wall-r { border-right: 2px solid transparent; }
    .wall-b { border-bottom: 2px solid transparent; }
    
    /* DEBUG CLASSES */
    .debug-maze .wall-r { border-right: 2px solid #00ffcc !important; }
    .debug-maze .wall-b { border-bottom: 2px solid #00ffcc !important; }
    
    .maze-player {
        width: 16px; height: 16px;
        background: white; border-radius: 50%;
        position: absolute; top: 8px; left: 8px;
        z-index: 3;
    }
    .maze-goal {
        width: 0; height: 0; 
        border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 16px solid red;
        position: absolute; top: 8px; left: 6px;
        z-index: 2;
    }
    .maze-circles {
        width: 20px; height: 20px;
        border: 2px solid #555; border-radius: 50%;
        position: absolute; top: 4px; left: 4px;
        z-index: 2;
    }
    .maze-btn { width: 40px; height: 40px; font-size: 20px; padding: 0; margin: 2px; }

    /* POPUP STYLES */
    #popup, #gameControlsPopup, #msPopup, #penaltyPopup{
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.95);
        display:none;
        flex-direction: column; justify-content:center; align-items:center;
        font-size:30px; text-align:center; box-sizing: border-box;
    }
    #popup, #gameControlsPopup, #msPopup { z-index: 900; border: 2px solid #00ffcc; }
    #penaltyPopup { z-index: 2000; background:rgba(200,0,0,0.95); border: 4px solid black;}
    
    .flash { animation:flash 0.6s infinite; }
    @keyframes flash{
        0%{background:black;color:red;} 50%{background:red;color:black;} 100%{background:black;color:red;}
    }
    #skipBtn{
        position:fixed; bottom:15px; right:15px; background:#330000; color:red; font-weight:bold; z-index: 1100;
    }

    /* GAME CANVAS */
    #gameContainer {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 10, 0, 1); z-index: 50;
    }
    canvas { display: block; }
    #gameUI {
        position: absolute; top: 90px; left: 20px; color: lime; font-size: 18px; pointer-events: none; z-index: 100;
    }
    .control-box { border: 2px solid #00ffcc; padding: 40px; background: #001100; max-width: 600px; }
    .key { border: 1px solid white; padding: 5px 10px; border-radius: 4px; display: inline-block; margin: 2px; color: white; }

    /* MINESWEEPER STYLES */
    #msGameContainer {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 5, 10, 0.95); z-index: 800;
        flex-direction: column; justify-content: flex-start; align-items: center;
        padding-top: 100px; padding-bottom: 50px; box-sizing: border-box; overflow-y: auto;
    }
    #msGrid {
        display: grid; grid-template-columns: repeat(8, 45px); gap: 3px; background: #00ffcc; padding: 3px; border: 2px solid #00ffcc;
    }
    .ms-cell {
        width: 45px; height: 45px; background: #001f33; display: flex; justify-content: center; align-items: center;
        font-size: 20px; font-weight: bold; cursor: pointer; user-select: none;
    }
    .ms-cell:hover { background: #00334d; }
    .ms-cell.revealed { background: black; cursor: default; }
    .ms-cell.mine { background: red; }
</style>
</head>
<body>

<header>
    NORTH AMERICAN AEROSPACE DEFENSE COMMAND PORTAL
    <div class="timer">Time Remaining: <span id="time">55:00</span></div>
</header>

<div id="start" class="section" style="display:block;text-align:center;padding-top:120px;">
    <h1>UNKNOWN ICBM DETECTED</h1>
    <p>Awaiting Authorization</p>
    <button onclick="beginMission()">BEGIN MISSION</button>
</div>

<div id="set1" class="section">
    <h2>Phase 1: Ground-Based Interceptor Authorization</h2>

    <div class="cluster">
        <h3>Cluster 1 ‚Äì Decipher the Threat</h3>
        <p><b>Problem:</b> You have received an encrypted message from the Space-Based Infrared System, letting you know if the incoming ICBM is a threat or just a test.</p>
        <p><b>Encrypted Message:</b> "WKH LFEP LV QRW D WHVW. LW LV D UHDO WKUHDW."</p>
        <p><b>Hint:</b> "Et tu, Brute?" </p>
        <p>Enter the full decrypted sentence:</p>
        <input id="a1" placeholder="XXX...">
        <button onclick="checkAnswer(1)">Submit</button>
        <p id="code1"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 2 ‚Äì Determine Launch Origin</h3>
        <p><b>Problem:</b> Email the Chinese Diplomatic Agency (chinesediplomat@gmail.com) to see if the ICBM launched from their country. </p>
        <p>They will respond with the source city.</p>
        <p>Enter the ICBM Source City:</p>
        <input id="a2" placeholder="City Name">
        <button onclick="checkAnswer(2)">Submit</button>
        <p id="code2"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 3 ‚Äì Maximum Distance Calculation</h3>
        <p><b>Problem:</b> Launched at 45¬∞ angle. g = 10 m/s¬≤. No air resistance.</p>
        <p>At t = 120s (2 mins), vertical velocity is 5,745 m/s.</p>
        <p>Find the maximum horizontal distance in miles (round to nearest 100 miles).</p>
        
        <div class="formula-box">
            <i>v<sub>y</sub></i> = <i>v<sub>0y</sub></i> ¬∑ sin(<i>Œ∏</i>) - <i>g</i> ¬∑ <i>t</i><br>
            <i>y</i> = <i>v<sub>0y</sub></i> ¬∑ <i>t</i> - ¬Ω<i>g</i><i>t</i>¬≤<br>
            <i>x</i> = <i>v<sub>0x</sub></i> ¬∑ <i>t<sub>total</sub></i><br>
            <span style="font-size:14px; font-family:'Courier New'">1 mile = 1609 meters</span>
        </div>

        <input id="a3" placeholder="Distance in Miles">
        <button onclick="checkAnswer(3)">Submit</button>
        <p id="code3"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 4 ‚Äì Target City Identification</h3>
        <p><b>Problem:</b> Given the documents provided and the target advisor's intelligence (they sit at the front of Kane 110), determine the most likely target city.</p>
        <p>Enter the city's 3-letter Airport Code:</p>
        <input id="a4" placeholder="XYZ">
        <button onclick="checkAnswer(4)">Submit</button>
        <p id="code4"></p>
    </div>

    <h3>Enter All 4 Authorization Codes</h3>
    <p style="font-size:12px; color:gray;">(Codes are generated above upon solving clusters)</p>
    <input class="launchInput" id="l1">
    <input class="launchInput" id="l2">
    <input class="launchInput" id="l3">
    <input class="launchInput" id="l4">
    <br>
    <button onclick="launchPhase1()">LAUNCH INTERCEPTOR</button>
</div>

<div id="set2" class="section">
    <h2>Phase 2: Emergency Defense Protocol</h2>

    <div class="cluster">
        <h3>Cluster 5 ‚Äì Altitude Logic Puzzle</h3>
        <p><b>Problem:</b>You have gotten 4 bits of information from your engineers tracking the ICBM. You have also found out that two of the engineers are actually spies and are lying (both their statements are false)! This means only 2 of the engineers have factual statements. Given the constraints, determine the missile's altitude in miles. You also know from a secret source that all digits are different.</p>
        <ul>
            <li><b>Alpha:</b> Digits in descending order. Ones is half of tens.</li>
            <li><b>Bravo:</b> Tens digit is 7. All digits sum to 14.</li>
            <li><b>Charlie:</b> All digits even. Ones digit is 8.</li>
            <li><b>Delta:</b> Hundreds odd, ones even. All digits < 6.</li>
        </ul>
        <p>Determine the missile altitude:</p>
        <input id="a5" placeholder="###">
        <button onclick="checkAnswer(5)">Submit</button>
        <p id="code5"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 6 ‚Äì Evacuation Protocol</h3>
        <p><b>Problem:</b> Create a plan to evacuate all personnel from the city and brief it to the GLP administrator. Upon completion, the administrator will provide a password to proceed.</p>
        <p>Enter the Administrator's Password:</p>
        <input id="a6" placeholder="Password">
        <button onclick="checkAnswer(6)">Submit</button>
        <p id="code6"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 7 ‚Äì Vector Collision</h3>
        <p><b>Problem: </b>The Missile Defense Agency has tracked the ICBM and determined its position and velocity vectors. Our GBI has a known starting position and velocity vector.</p>
        <p>ICBM: r = &lt;3000, 2000&gt; m, v = &lt;-150, -100&gt; m/s</p>
        <p>Interceptor: Starts at &lt;0,0&gt;, v = &lt;90, 60&gt; m/s</p>
        <p>Once launched how many seconds until collision?</p>
        
        <div class="formula-box">
            <i>r<sub>rel</sub></i> = <i>r<sub>R</sub></i> - <i>r<sub>I</sub></i><br>
            <i>v<sub>rel</sub></i> = <i>v<sub>R</sub></i> - <i>v<sub>I</sub></i><br>
            <i>r<sub>rel</sub></i> + <i>v<sub>rel</sub></i> ¬∑ <i>t</i> = 0
        </div>

        <input id="a7" placeholder="Seconds">
        <button onclick="checkAnswer(7)">Submit</button>
        <p id="code7"></p>
    </div>

    <h3>Enter All 3 Authorization Codes</h3>
    <input class="launchInput" id="l5">
    <input class="launchInput" id="l6">
    <input class="launchInput" id="l7">
    <br>
    <button onclick="launchPhase2()">FINAL LAUNCH</button>
</div>

<div id="transportScreen" class="section" style="text-align: center;">
    <h2 style="color:red; font-size:36px;">PERSONNEL RELOCATION</h2>
    <div class="cluster" style="display:inline-block; max-width:800px; text-align:left; font-size:18px; line-height: 1.5;">
        <p>Your leadership is being taken to Cheyenne Mountain. The current GLP lead and 3 other Cadets must go into the foyer.</p>
        <p>The POC Administrator will give them some documents. You are allowed to use your phones <b>only</b> to hold a Teams call between the group in the foyer and the group inside Kane 110.</p>
        
        <div style="text-align: center; margin-top: 30px;">
            <button style="padding: 15px 30px; font-size: 20px;" onclick="showOverrideStage()">Personnel have been transported</button>
        </div>
    </div>
</div>

<div id="overrideStage" class="section" style="text-align: center; padding-top: 0px;">
    <h2 style="color:red; font-size:30px; margin-bottom: 5px;">MANUAL OVERRIDE REQUIRED</h2>
    <p style="font-size:16px; color:yellow; margin-top:0;">Complete all physical overrides to initiate rocket launch!</p>
    
    <div class="override-container">
        
        <div class="cluster override-box">
            <div style="width: 100%;">
                <h3 style="margin-top:0;">Relay Levers</h3>
                <p style="font-size: 14px;">We forgot the combination! Figure it out to proceed.</p>
            </div>
            <div class="lever-container">
                <button id="lev0" class="lever up" onclick="toggleLever(0)">UP</button>
                <button id="lev1" class="lever up" onclick="toggleLever(1)">UP</button>
                <button id="lev2" class="lever up" onclick="toggleLever(2)">UP</button>
                <button id="lev3" class="lever up" onclick="toggleLever(3)">UP</button>
            </div>
            <div style="width: 100%;">
                <button onclick="checkLevers()">TEST LEVERS</button>
                <p id="leverStatus" style="font-weight:bold; font-size: 18px; min-height: 20px;"></p>
            </div>
        </div>

        <div class="cluster override-box">
            <div style="width: 100%;">
                <h3 style="margin-top:0;">Power Wires</h3>
                <p style="font-size: 14px;">Cut the correct wire to route power.</p>
            </div>
            <div class="wire-container">
                <div id="w1" class="wire wire-white" onclick="cutWire('white', 'w1')"></div>
                <div id="w2" class="wire wire-yellow" onclick="cutWire('yellow', 'w2')"></div>
                <div id="w3" class="wire wire-yellow" onclick="cutWire('yellow', 'w3')"></div>
                <div id="w4" class="wire wire-blue" onclick="cutWire('blue', 'w4')"></div>
                <div id="w5" class="wire wire-red" onclick="cutWire('red', 'w5')"></div>
            </div>
            <div style="width: 100%;">
                <p id="wireStatus" style="font-weight:bold; font-size: 18px; min-height: 20px;"></p>
            </div>
        </div>

        <div class="cluster override-box">
            <div style="width: 100%;">
                <h3 style="margin-top:0;">Guidance Maze</h3>
                <p style="font-size: 14px;">Navigate to the triangle. (Use buttons or WASD)</p>
            </div>
            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                <button class="maze-btn" onclick="moveMaze(-1, 0)">‚óÄ</button>
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <button class="maze-btn" onclick="moveMaze(0, -1)" style="margin-bottom:5px;">‚ñ≤</button>
                    <div class="maze-container" id="mazeGrid"></div>
                    <button class="maze-btn" onclick="moveMaze(0, 1)" style="margin-top:5px;">‚ñº</button>
                </div>
                <button class="maze-btn" onclick="moveMaze(1, 0)">‚ñ∂</button>
            </div>
            <div style="width: 100%;">
                <p id="mazeStatus" style="font-weight:bold; font-size: 18px; min-height: 20px;"></p>
            </div>
        </div>

    </div>
</div>

<div id="debugMenu" style="position:fixed; bottom:15px; left:15px; z-index: 1100; display:none; gap:5px; align-items:center;">
    <input id="debugInput" placeholder="Code" style="width:60px; font-size:12px; padding:4px;">
    <button onclick="checkDebug()" style="margin:0; font-size:12px; padding:4px 8px;">DEBUG</button>
</div>

<div id="penaltyPopup">
    <h1 id="penaltyTitle" style="color:black; font-size:60px; margin-bottom: 0;">INVALID INPUT</h1>
    <h2 style="color:white; font-size: 40px;">SYSTEM LOCKOUT: <span id="penaltyTime">60</span>s</h2>
    <p style="color:black; font-weight: bold;">(Do NOT refresh the page)</p>
</div>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="gameUI">RADAR TRACKING ACTIVE</div>
</div>
<div id="gameControlsPopup">
    <div class="control-box">
        <h2>INTERCEPTOR CONTROLS</h2>
        <p>USE KEYBOARD TO GUIDE INTERCEPTOR</p>
        <p>
            <span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span>
            <br>OR<br>
            <span class="key">‚Üë</span> <span class="key">‚Üê</span> <span class="key">‚Üì</span> <span class="key">‚Üí</span>
        </p>
        <p style="color:red; margin-top:20px;">INTERCEPT THE HOSTILE TARGET</p>
        <button onclick="startGameEngine()">ENGAGE</button>
    </div>
</div>

<div id="msPopup">
    <div class="control-box" style="border-color: red;">
        <h2 style="color:red;">WARNING: CYBER ATTACK DETECTED</h2>
        <p>The servers are infected with instances of a virus.</p>
        <p style="font-size:18px; line-height:1.4;">
            <b>RULES:</b> Find all instances to restart the server and continue. 
            <br><br>
            - Left-click a sector to scan it.<br>
            - The number reveals how many viruses are in adjacent sectors.<br>
            - Right-click to flag a suspected virus location.<br>
            - Isolate all safe sectors to successfully reboot the system.
        </p>
        <button style="border-color:red; color:red;" onclick="startMinesweeper()">CONTINUE TO SCAN</button>
    </div>
</div>

<div id="msGameContainer">
    <h2 style="color:red; margin-bottom: 10px;">SYSTEM OVERRIDE REQUIRED</h2>
    
    <p id="msFlagCounter" style="color:yellow; font-weight:bold; font-size:22px; margin: 10px 0;">VIRUSES UNFLAGGED: 10</p>

    <div id="msGrid" oncontextmenu="return false;"></div>
    <p style="margin-top:10px; color:gray;">Left-Click: Scan Sector | Right-Click: Flag Virus</p>

    <div style="margin-top: 30px; border-top: 2px dashed #00ffcc; padding-top: 20px; text-align: center; max-width: 600px;">
        <p>To proceed, enter the cyber officer's decrypted code, the encrypted code is <b>ORTSGMRMTNXJFVVM</b></p>
        
        <div class="formula-box" style="font-family: monospace; font-size: 14px; text-align: left;">
            <b>SUBSTITUTION KEY:</b><br>
            A=Z, B=Y, C=X, D=W, E=V, F=U, G=T, H=S, I=R, J=Q, K=P, L=O, M=N<br>
            N=M, O=L, P=K, Q=J, R=I, S=H, T=G, U=F, V=E, W=D, X=C, Y=B, Z=A
        </div>

        <input id="cyberCodeInput" placeholder="Decrypted Code" style="text-align: center; width: 250px;">
        <button onclick="verifyCyberCode()">VERIFY</button>
        <p id="cyberCodeStatus" style="font-weight:bold; margin-top: 10px;"></p>
    </div>

    <button id="msContinueBtn" style="margin-top: 20px; padding: 15px 30px; font-size: 16px; background: #333; color: #777; border-color: #777; cursor: not-allowed;" disabled onclick="finishCyberAttack()">AWAITING SYSTEM CLEARANCE...</button>

</div>

<div id="popup"></div>
<button id="skipBtn" onclick="skipTime()">‚ö† DO NOT PRESS</button>

<script>
/* --- WEB AUDIO API (SOUND EFFECTS) --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    
    if (type === 'click') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
        gainNode.gain.setValueAtTime(0.1, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'error') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, now);
        gainNode.gain.setValueAtTime(0.2, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'success') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.setValueAtTime(600, now + 0.1);
        osc.frequency.setValueAtTime(800, now + 0.2);
        gainNode.gain.setValueAtTime(0.05, now);
        gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'ms_reveal') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(600, now);
        gainNode.gain.setValueAtTime(0.05, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
        osc.start(now); osc.stop(now + 0.05);
    } else if (type === 'ms_flag') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(900, now);
        gainNode.gain.setValueAtTime(0.05, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'explosion') {
        let bufferSize = audioCtx.sampleRate * 0.5; 
        let buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        let data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        let noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        let filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 1000;
        noise.connect(filter); filter.connect(gainNode);
        gainNode.gain.setValueAtTime(0.3, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        noise.start(now);
    } else if (type === 'rocket_thrust') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(100, now);
        gainNode.gain.setValueAtTime(0.02, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
    }
}

// Global UI click sounds
document.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('wire') || e.target.classList.contains('lever')) {
        // Exclude elements that have their own specific sound effects 
        if(!e.target.classList.contains('maze-btn') && !e.target.classList.contains('ms-cell')) {
             playSound('click');
        }
    }
});


/* --- CORE LOGIC --- */
let time=55*60;
let timer=null;

let answers = {
    1: "THE ICBM IS NOT A TEST. IT IS A REAL THREAT.", 
    2: "PYONGYANG",                                   
    3: "6000",                                        
    4: "SEA",                                         
    5: "542",                                         
    6: "EVACUATE",                                    
    7: "12.5"                                         
};

let staticCodes = {
    1: "8XJ2", 2: "3B9Q", 3: "K4M1", 4: "7D5V", 5: "P2L9", 6: "4X8Z", 7: "W1N6"
};

let codesRevealed = {}; 
let currentPhase = 1;

function beginMission(){
    document.getElementById("start").style.display="none";
    document.getElementById("set1").style.display="block";
    timer=setInterval(updateTimer,1000);
}

function checkDebug() {
    let val = document.getElementById("debugInput").value.trim().toUpperCase();
    if(val === "DAWG") {
        document.getElementById("mazeGrid").classList.toggle("debug-maze");
        document.getElementById("debugInput").value = ""; 
    }
}

// Ensure Cyber Attack doesn't overlap the minigames or full screen transitions
function checkCyberTrigger() {
    if(!document.getElementById("popup")) return;

    if (time <= 44 * 60 && !msTriggered && !gameActive && !penaltyActive) {
        let p1 = document.getElementById("popup").style.display;
        let p2 = document.getElementById("gameControlsPopup").style.display;
        let start = document.getElementById("start").style.display;
        
        if (p1 !== "flex" && p2 !== "flex" && start === "none") {
            msTriggered = true;
            document.getElementById("msPopup").style.display = "flex";
            playSound('error');
        }
    }
}

function updateTimer(){
    let m=Math.floor(time/60);
    let s=time%60;
    document.getElementById("time").innerText=
    m.toString().padStart(2,'0')+":"+s.toString().padStart(2,'0');
    
    checkCyberTrigger();

    if(time<=0){
        document.body.innerHTML="<h1 style='color:red;text-align:center;padding-top:200px; position:relative; z-index:9999;'>MISSION FAILURE<br>ITS TOO LATE TO STOP THE ATTACK, USA IS COMPROMISED</h1>";
        playSound('explosion');
        clearInterval(timer);
    }
    time--;
}

function checkAnswer(n){
    let val = document.getElementById("a"+n).value.trim().toUpperCase();
    if(n === 1 && val.endsWith('.')) { val = val.slice(0, -1); }
    let isCorrect = false;

    if(val === "DAWG") { isCorrect = true; } 
    else if(n === 1) {
        let cleanInput = val.replace(/[^A-Z]/g, ""); 
        let cleanAnswer = answers[1].replace(/[^A-Z]/g, "");
        if(cleanInput === cleanAnswer) isCorrect = true;
    } else {
        if(val === answers[n]) isCorrect = true;
    }

    if(isCorrect){
        if(!codesRevealed[n]){
            codesRevealed[n] = staticCodes[n]; 
            document.getElementById("code"+n).innerText = "Authorization Code: " + staticCodes[n];
            document.getElementById("code"+n).style.color = "#00ffcc";
            playSound('success');
        }
    } else {
        playSound('error');
        alert("INCORRECT ANSWER");
    }
}

function launchPhase1(){
    let v1 = document.getElementById("l1").value.trim().toUpperCase();
    let v2 = document.getElementById("l2").value.trim().toUpperCase();
    let v3 = document.getElementById("l3").value.trim().toUpperCase();
    let v4 = document.getElementById("l4").value.trim().toUpperCase();

    if(
        (v1 === staticCodes[1] || v1 === "DAWG") &&
        (v2 === staticCodes[2] || v2 === "DAWG") &&
        (v3 === staticCodes[3] || v3 === "DAWG") &&
        (v4 === staticCodes[4] || v4 === "DAWG")
    ){
        currentPhase = 1;
        initGameSequence();
    }else{
        playSound('error');
        alert("INVALID AUTHORIZATION SEQUENCE");
    }
}

function launchPhase2(){
    let v5 = document.getElementById("l5").value.trim().toUpperCase();
    let v6 = document.getElementById("l6").value.trim().toUpperCase();
    let v7 = document.getElementById("l7").value.trim().toUpperCase();

    if(
        (v5 === staticCodes[5] || v5 === "DAWG") &&
        (v6 === staticCodes[6] || v6 === "DAWG") &&
        (v7 === staticCodes[7] || v7 === "DAWG")
    ){
        currentPhase = 2;
        
        if(time > 600) { // Over 10 minutes (600 seconds)
            document.getElementById("set2").style.display = "none";
            document.getElementById("transportScreen").style.display = "block";
        } else {
            initGameSequence();
        }

    }else{
        playSound('error');
        alert("INVALID AUTHORIZATION SEQUENCE");
    }
}

/* --- OVERRIDE PUZZLES LOGIC --- */
function showOverrideStage() {
    document.getElementById("transportScreen").style.display = "none";
    document.getElementById("overrideStage").style.display = "block";
    document.getElementById("debugMenu").style.display = "flex";
    renderMaze(); 
}

let leversSolved = false;
let wiresSolved = false;
let mazeSolved = false;
let penaltyActive = false;

function checkAllOverride() {
    if (leversSolved && wiresSolved && mazeSolved) {
        playSound('success');
        setTimeout(() => {
            document.getElementById("overrideStage").style.display = "none";
            document.getElementById("debugMenu").style.display = "none";
            initGameSequence();
        }, 1500);
    }
}

// 1. LEVERS
let levers = [1, 1, 1, 1];

function toggleLever(index) {
    if(leversSolved) return;
    levers[index] = levers[index] === 1 ? 0 : 1;
    let btn = document.getElementById("lev" + index);
    
    if(levers[index] === 1) {
        btn.className = "lever up"; btn.innerText = "UP";
    } else {
        btn.className = "lever down"; btn.innerText = "DOWN";
    }
}

function checkLevers() {
    if(leversSolved) return;
    if (levers[0] === 1 && levers[1] === 0 && levers[2] === 0 && levers[3] === 1) {
        leversSolved = true;
        document.getElementById("leverStatus").innerText = "LEVERS: LOCKED";
        document.getElementById("leverStatus").style.color = "lime";
        playSound('success');
        checkAllOverride();
    } else {
        playSound('error');
        alert("INCORRECT CONFIGURATION.");
    }
}

// 2. WIRES
function cutWire(color, elementId) {
    if (wiresSolved || penaltyActive) return;
    
    document.getElementById(elementId).classList.add("cut");
    
    if (color === 'white') {
        wiresSolved = true;
        document.getElementById("wireStatus").innerText = "WIRES: BYPASSED";
        document.getElementById("wireStatus").style.color = "lime";
        playSound('success');
        checkAllOverride();
    } else {
        triggerPenalty(60, "INVALID WIRE CUT");
    }
}

// Shared Penalty Function
function triggerPenalty(seconds, titleMsg) {
    playSound('error');
    penaltyActive = true;
    let p = document.getElementById("penaltyPopup");
    document.getElementById("penaltyTitle").innerText = titleMsg;
    p.style.display = "flex";
    let timeLeft = seconds;
    document.getElementById("penaltyTime").innerText = timeLeft;
    
    let int = setInterval(() => {
        timeLeft--;
        document.getElementById("penaltyTime").innerText = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(int);
            p.style.display = "none";
            penaltyActive = false;
            checkCyberTrigger(); 
        }
    }, 1000);
}

// 3. MAZE (KTaNE Right-Middle Authentic Walls)
let px = 0, py = 5; // Start bottom-left
let gx = 5, gy = 0; // End top-right

// Correct KTaNE Right-Middle Maze Data (1=wall, 0=path)
const vWalls = [
    [1, 0, 1, 0, 0, 0], // Row 0
    [1, 1, 1, 0, 1, 0], // Row 1
    [0, 1, 1, 1, 0, 0], // Row 2
    [0, 1, 0, 1, 1, 0], // Row 3
    [0, 1, 1, 1, 0, 0], // Row 4
    [0, 0, 0, 1, 0, 0]  // Row 5
];
const hWalls = [
    [0, 0, 0, 1, 0, 0], // Row 0
    [0, 0, 0, 0, 1, 0], // Row 1
    [0, 1, 1, 0, 0, 1], // Row 2
    [1, 0, 0, 0, 0, 0], // Row 3
    [0, 1, 1, 0, 1, 0], // Row 4
    [0, 0, 0, 0, 0, 0]  // Row 5
];

function renderMaze() {
    let m = document.getElementById("mazeGrid");
    m.innerHTML = "";
    for (let y = 0; y < 6; y++) {
        let row = document.createElement("div");
        row.className = "maze-row";
        for (let x = 0; x < 6; x++) {
            let cell = document.createElement("div");
            cell.className = "maze-cell";
            if (vWalls[y][x]) cell.classList.add("wall-r");
            if (hWalls[y][x]) cell.classList.add("wall-b");
            
            if ((x===4 && y===0) || (x===2 && y===4)) {
                let circ = document.createElement("div");
                circ.className = "maze-circles";
                cell.appendChild(circ);
            }

            if (x === px && y === py) {
                let p = document.createElement("div");
                p.className = "maze-player";
                cell.appendChild(p);
            }
            if (x === gx && y === gy) {
                let g = document.createElement("div");
                g.className = "maze-goal";
                cell.appendChild(g);
            }
            row.appendChild(cell);
        }
        m.appendChild(row);
    }
}

function moveMaze(dx, dy) {
    if (mazeSolved || penaltyActive) return;
    playSound('click');
    let nx = px + dx;
    let ny = py + dy;

    if (nx < 0 || nx > 5 || ny < 0 || ny > 5) return; 
    
    let hitWall = false;
    if (dx === 1 && vWalls[py][px]) hitWall = true; 
    else if (dx === -1 && vWalls[py][nx]) hitWall = true; 
    else if (dy === 1 && hWalls[py][px]) hitWall = true; 
    else if (dy === -1 && hWalls[ny][px]) hitWall = true; 

    if(hitWall) {
        triggerPenalty(15, "WALL IMPACT DETECTED");
        return;
    }
    
    px = nx; py = ny;
    renderMaze();
    
    if (px === gx && py === gy) {
        mazeSolved = true;
        document.getElementById("mazeStatus").innerText = "MAZE: ROUTED";
        document.getElementById("mazeStatus").style.color = "lime";
        playSound('success');
        checkAllOverride();
    }
}

function initGameSequence(){
    let popup=document.getElementById("popup");
    popup.style.display="flex";
    popup.className="flash";
    popup.innerHTML="LAUNCH INITIATED...<br>ACQUIRING TARGET";
    
    setTimeout(()=>{
        popup.style.display="none";
        popup.className="";
        document.getElementById("gameControlsPopup").style.display = "flex";
    }, 2000);
}

function skipTime(){
    time-=300;
    if(time<0) time=0;
    checkCyberTrigger();
}

/* --- MINESWEEPER & CIPHER LOGIC --- */
let msTriggered = false;
let msWon = false;
let codeAccepted = false;
let msData = [];
const msRows = 8;
const msCols = 8;
const msStaticMines = [
    [0, 1], [1, 5], [2, 2], [3, 7], [4, 0],
    [5, 4], [6, 1], [6, 6], [7, 3], [7, 7]
];

function startMinesweeper() {
    document.getElementById("msPopup").style.display = "none";
    document.getElementById("msGameContainer").style.display = "flex";
    initMinesweeper();
}

function initMinesweeper() {
    msWon = false;
    evaluateCyberClear(); 
    msData = [];
    const gridEl = document.getElementById("msGrid");
    gridEl.innerHTML = "";

    for(let r=0; r<msRows; r++) {
        let row = [];
        for(let c=0; c<msCols; c++) {
            row.push({ r: r, c: c, mine: false, revealed: false, flagged: false, adjacent: 0 });
        }
        msData.push(row);
    }

    msStaticMines.forEach(pos => {
        msData[pos[0]][pos[1]].mine = true;
    });

    for(let r=0; r<msRows; r++) {
        for(let c=0; c<msCols; c++) {
            if(msData[r][c].mine) continue;
            let count = 0;
            for(let i=-1; i<=1; i++){
                for(let j=-1; j<=1; j++){
                    let nr = r+i, nc = c+j;
                    if(nr>=0 && nr<msRows && nc>=0 && nc<msCols && msData[nr][nc].mine){
                        count++;
                    }
                }
            }
            msData[r][c].adjacent = count;
        }
    }
    document.getElementById("msFlagCounter").innerText = "VIRUSES UNFLAGGED: " + msStaticMines.length;
    renderMsGrid();
}

function renderMsGrid() {
    const gridEl = document.getElementById("msGrid");
    gridEl.innerHTML = "";
    
    for(let r=0; r<msRows; r++) {
        for(let c=0; c<msCols; c++) {
            let cell = msData[r][c];
            let div = document.createElement("div");
            div.className = "ms-cell";
            
            div.addEventListener("mousedown", (e) => {
                if(e.button === 0) msClick(r, c); 
                if(e.button === 2) msFlag(r, c);  
            });

            if(cell.revealed) {
                div.classList.add("revealed");
                if(cell.mine) {
                    div.classList.add("mine");
                    div.innerText = "üëæ";
                } else if(cell.adjacent > 0) {
                    div.innerText = cell.adjacent;
                    if(cell.adjacent === 1) div.style.color = "#00ffcc";
                    else if(cell.adjacent === 2) div.style.color = "lime";
                    else if(cell.adjacent === 3) div.style.color = "yellow";
                    else div.style.color = "red";
                }
            } else if(cell.flagged) {
                div.innerText = "üö©";
            }
            gridEl.appendChild(div);
        }
    }
}

function msClick(r, c) {
    if(msWon) return; 
    let cell = msData[r][c];
    if(cell.flagged || cell.revealed) return;
    
    cell.revealed = true;
    playSound('ms_reveal');
    
    if(cell.mine) {
        playSound('explosion');
        renderMsGrid(); 
        setTimeout(() => {
            alert("VIRUS TRIGGERED. REBOOTING SYSTEM...");
            initMinesweeper(); 
        }, 500);
        return;
    }
    
    if(cell.adjacent === 0) {
        for(let i=-1; i<=1; i++){
            for(let j=-1; j<=1; j++){
                let nr = r+i, nc = c+j;
                if(nr>=0 && nr<msRows && nc>=0 && nc<msCols) {
                    if(!msData[nr][nc].revealed) msClick(nr, nc);
                }
            }
        }
    }
    renderMsGrid();
    checkMsWin();
}

function msFlag(r, c) {
    if(msWon) return;
    let cell = msData[r][c];
    if(cell.revealed) return;
    
    // Count active flags
    let currentFlags = 0;
    for(let row of msData) for(let col of row) if(col.flagged) currentFlags++;
    
    // Prevent adding more flags than total mines
    if(!cell.flagged && currentFlags >= msStaticMines.length) {
        playSound('error');
        return;
    }
    
    cell.flagged = !cell.flagged;
    playSound('ms_flag');
    
    // Update count after toggle
    currentFlags = 0;
    for(let row of msData) for(let col of row) if(col.flagged) currentFlags++;
    document.getElementById("msFlagCounter").innerText = "VIRUSES UNFLAGGED: " + (msStaticMines.length - currentFlags);
    
    renderMsGrid();
}

function checkMsWin() {
    let revealedSafe = 0;
    const totalSafe = (msRows * msCols) - msStaticMines.length;
    
    for(let r=0; r<msRows; r++) {
        for(let c=0; c<msCols; c++) {
            if(msData[r][c].revealed && !msData[r][c].mine) {
                revealedSafe++;
            }
        }
    }
    
    if(revealedSafe === totalSafe && !msWon) {
        msWon = true;
        playSound('success');
        setTimeout(() => {
            alert("VIRUSES ISOLATED. SERVER CORE STABILIZED.");
            evaluateCyberClear();
        }, 100);
    }
}

function verifyCyberCode() {
    let val = document.getElementById("cyberCodeInput").value.trim().toUpperCase();
    if(val === "LIGHTNINGMCQUEEN" || val === "DAWG") {
        codeAccepted = true;
        playSound('success');
        document.getElementById("cyberCodeStatus").innerText = "CODE ACCEPTED";
        document.getElementById("cyberCodeStatus").style.color = "lime";
        document.getElementById("cyberCodeInput").disabled = true;
        evaluateCyberClear();
    } else {
        playSound('error');
        alert("INCORRECT DECRYPTION");
    }
}

function evaluateCyberClear() {
    let btn = document.getElementById("msContinueBtn");
    if(msWon && codeAccepted) {
        btn.disabled = false;
        btn.style.background = "#001f33";
        btn.style.color = "#00ffcc";
        btn.style.borderColor = "#00ffcc";
        btn.style.cursor = "pointer";
        btn.innerText = "ALL CLEAR: RESTART SERVER AND CONTINUE";
    } else {
        btn.disabled = true;
        btn.style.background = "#333";
        btn.style.color = "#777";
        btn.style.borderColor = "#777";
        btn.style.cursor = "not-allowed";
        
        if(msWon) {
            btn.innerText = "AWAITING CYBER CODE...";
        } else if(codeAccepted) {
            btn.innerText = "AWAITING VIRUS ISOLATION...";
        } else {
            btn.innerText = "AWAITING SYSTEM CLEARANCE...";
        }
    }
}

function finishCyberAttack() {
    document.getElementById("msGameContainer").style.display = "none";
    alert("SERVERS RESTARTED SUCCESSFULLY. RESUMING MISSION.");
}

/* --- INTERCEPTOR GAME ENGINE --- */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let gameLoopId;
let icbm = { x: 0, y: 0, vx: 0, vy: 0, g: 0.003 };
let player = { x: 0, y: 0, speed: 5, w: 20, h: 20 };
let explosions = [];
let keys = {};
let gameActive = false;
let frameCount = 0;

window.addEventListener('keydown', (e) => { 
    keys[e.key] = true; 
    
    if(document.getElementById("overrideStage").style.display === "block" && !penaltyActive) {
        if(e.key === 'ArrowUp' || e.key === 'w') moveMaze(0, -1);
        if(e.key === 'ArrowDown' || e.key === 's') moveMaze(0, 1);
        if(e.key === 'ArrowLeft' || e.key === 'a') moveMaze(-1, 0);
        if(e.key === 'ArrowRight' || e.key === 'd') moveMaze(1, 0);
    }
});
window.addEventListener('keyup', (e) => { keys[e.key] = false; });

function resizeCanvas(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

function startGameEngine(){
    document.getElementById("gameControlsPopup").style.display = "none";
    document.getElementById("gameContainer").style.display = "block";
    resizeCanvas();
    
    player.x = canvas.width / 2;
    player.y = canvas.height - 100;
    
    icbm.x = 0;
    icbm.y = canvas.height / 2; 
    let framesToLand = 1000; 
    icbm.vx = canvas.width / framesToLand;
    icbm.vy = (canvas.height - (canvas.height / 2) - (0.5 * icbm.g * framesToLand * framesToLand)) / framesToLand;
    
    explosions = [];
    gameActive = true;
    frameCount = 0;
    loop();
}

function loop(){
    if(!gameActive) return;
    frameCount++;

    ctx.fillStyle = "rgba(0, 10, 0, 0.4)"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.strokeStyle = "#003300";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0; i<canvas.width; i+=100){ ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); }
    for(let i=0; i<canvas.height; i+=100){ ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); }
    ctx.stroke();

    let isMoving = false;
    if(keys['w'] || keys['ArrowUp']) { player.y -= player.speed; isMoving = true; }
    if(keys['s'] || keys['ArrowDown']) { player.y += player.speed; isMoving = true; }
    if(keys['a'] || keys['ArrowLeft']) { player.x -= player.speed; isMoving = true; }
    if(keys['d'] || keys['ArrowRight']) { player.x += player.speed; isMoving = true; }
    
    if (isMoving && frameCount % 8 === 0) playSound('rocket_thrust');

    let padding = 15;
    if(player.x < padding) player.x = padding;
    if(player.x > canvas.width - padding) player.x = canvas.width - padding;
    if(player.y < padding) player.y = padding;
    if(player.y > canvas.height - padding) player.y = canvas.height - padding;

    ctx.fillStyle = "#00ffcc";
    ctx.beginPath();
    ctx.moveTo(player.x, player.y - 10);
    ctx.lineTo(player.x - 10, player.y + 10);
    ctx.lineTo(player.x + 10, player.y + 10);
    ctx.fill();

    icbm.x += icbm.vx;
    icbm.y += icbm.vy;
    icbm.vy += icbm.g; 
    
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.moveTo(icbm.x + 15, icbm.y);
    ctx.lineTo(icbm.x - 5, icbm.y - 5);
    ctx.lineTo(icbm.x - 5, icbm.y + 5);
    ctx.fill();
    ctx.font = "14px Courier";
    ctx.fillStyle = "white";
    ctx.fillText("HOSTILE", icbm.x - 20, icbm.y - 15);

    let dist = Math.hypot(icbm.x - player.x, icbm.y - player.y);
    
    if(dist < 30){
        handleGameEnd(true); 
        return;
    }

    if(icbm.x >= canvas.width || icbm.y >= canvas.height){
        icbm.x = Math.min(icbm.x, canvas.width - 15);
        icbm.y = Math.min(icbm.y, canvas.height - 15);
        handleGameEnd(false); 
        return;
    }

    requestAnimationFrame(loop);
}

function handleGameEnd(isHit){
    gameActive = false;
    playSound('explosion');
    
    if(isHit){
        ctx.fillStyle = "orange";
        ctx.beginPath();
        ctx.arc(icbm.x, icbm.y, 50, 0, Math.PI*2);
        ctx.fill();
    }

    setTimeout(()=>{
        document.getElementById("gameContainer").style.display = "none";
        
        if(currentPhase === 1){
            let popup = document.getElementById("popup");
            popup.style.display = "flex";
            popup.className = "flash"; 
            
            let msg = isHit ? "LAST MINUTE MALFUNCTION" : "INTERCEPTION FAILED.";
            msg += "<br><br>GBI MISSED TARGET.<br>TIME IS TICKING...";
            
            popup.innerHTML = "<div style='border:2px solid red; padding:20px; background:black;'>" + msg + "</div>";
            playSound('error');
            
            setTimeout(()=>{
                popup.style.display="none";
                popup.className="";
                document.getElementById("set1").style.display="none";
                document.getElementById("set2").style.display="block";
                checkCyberTrigger(); 
            }, 4000);

        } else if (currentPhase === 2){
            if(isHit){
                document.body.innerHTML="<h1 style='color:lime;text-align:center;padding-top:200px;font-size:50px;'>MISSION SUCCESS<br>THREAT NEUTRALIZED</h1>";
                playSound('success');
                clearInterval(timer);
            } else {
                playSound('error');
                alert("MISSED TARGET - RE-ENGAGING TRACKING SYSTEMS");
                startGameEngine();
            }
        }
    }, 500);
}

</script>

</body>
</html>
