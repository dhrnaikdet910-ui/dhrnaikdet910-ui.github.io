<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NORAD Strategic Defense Network</title>

<style>
    body{
        margin:0;
        background:black;
        color:#00ffcc;
        font-family:"Courier New", monospace;
        overflow: hidden;
    }
    header{
        background:#050a12;
        padding:20px;
        text-align:center;
        font-size:26px;
        border-bottom:2px solid #00ffcc;
        position: relative;
        z-index: 1000;
    }
    .timer{
        font-size:20px;
        color:#ff3333;
    }
    .section{
        display:none;
        padding:20px;
        height: 80vh;
        overflow-y: auto;
        padding-bottom: 100px;
    }
    .cluster{
        border:1px solid #00ffcc;
        padding:15px;
        margin-bottom:20px;
        background:#07131f;
    }
    .formula-box {
        background: #001a00;
        border-left: 4px solid #00ffcc;
        padding: 10px 15px;
        margin: 15px 0;
        font-family: "Times New Roman", Times, serif;
        font-size: 18px;
        color: #ccffcc;
        line-height: 1.6;
    }
    .formula-box i { font-style: italic; }
    
    button{
        background:#001f33;
        color:#00ffcc;
        border:1px solid #00ffcc;
        padding:8px 16px;
        margin-top:10px;
        cursor:pointer;
        font-family: inherit;
        font-weight: bold;
    }
    button:hover{ background:#00334d; }
    input{
        background:black;
        color:#00ffcc;
        border:1px solid #00ffcc;
        padding:6px;
        font-family: inherit;
        width: 300px; 
    }
    .launchInput{
        width:100px;
        text-align:center;
    }
    
    /* LEVER PUZZLE STYLES */
    .lever-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 40px 0;
    }
    .lever {
        width: 80px;
        height: 80px;
        font-size: 20px;
        border-radius: 8px;
        transition: 0.2s;
    }
    .lever.up {
        background: lime;
        color: black;
        border-color: lime;
        box-shadow: 0px -5px 0px 0px #009900 inset;
    }
    .lever.down {
        background: red;
        color: white;
        border-color: red;
        box-shadow: 0px 5px 0px 0px #990000 inset;
    }

    /* POPUP STYLES */
    #popup, #gameControlsPopup, #msPopup{
        position:fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgba(0,0,0,0.95);
        display:none;
        flex-direction: column;
        justify-content:center;
        align-items:center;
        font-size:30px;
        text-align:center;
        z-index: 900;
        border: 2px solid #00ffcc;
        box-sizing: border-box;
    }
    .flash{
        animation:flash 0.6s infinite;
    }
    @keyframes flash{
        0%{background:black;color:red;}
        50%{background:red;color:black;}
        100%{background:black;color:red;}
    }
    #skipBtn{
        position:fixed;
        bottom:15px;
        right:15px;
        background:#330000;
        color:red;
        font-weight:bold;
        z-index: 1100;
    }

    /* GAME CANVAS */
    #gameContainer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 10, 0, 1);
        z-index: 50;
    }
    canvas { display: block; }
    #gameUI {
        position: absolute;
        top: 90px;
        left: 20px;
        color: lime;
        font-size: 18px;
        pointer-events: none;
        z-index: 100;
    }
    .control-box {
        border: 2px solid #00ffcc;
        padding: 40px;
        background: #001100;
        max-width: 600px;
    }
    .key {
        border: 1px solid white;
        padding: 5px 10px;
        border-radius: 4px;
        display: inline-block;
        margin: 2px;
        color: white;
    }

    /* MINESWEEPER STYLES */
    #msGameContainer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 5, 10, 0.95);
        z-index: 800;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding-top: 100px;
        padding-bottom: 50px;
        box-sizing: border-box;
        overflow-y: auto;
    }
    #msGrid {
        display: grid;
        grid-template-columns: repeat(8, 45px);
        gap: 3px;
        background: #00ffcc;
        padding: 3px;
        border: 2px solid #00ffcc;
    }
    .ms-cell {
        width: 45px;
        height: 45px;
        background: #001f33;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
    }
    .ms-cell:hover { background: #00334d; }
    .ms-cell.revealed { background: black; cursor: default; }
    .ms-cell.mine { background: red; }
</style>
</head>
<body>

<header>
    NORTH AMERICAN AEROSPACE DEFENSE COMMAND PORTAL
    <div class="timer">Time Remaining: <span id="time">55:00</span></div>
</header>

<div id="start" class="section" style="display:block;text-align:center;padding-top:120px;">
    <h1>UNKNOWN ICBM DETECTED</h1>
    <p>Awaiting Authorization</p>
    <button onclick="beginMission()">BEGIN MISSION</button>
</div>

<div id="set1" class="section">
    <h2>Phase 1: Ground-Based Interceptor Authorization</h2>

    <div class="cluster">
        <h3>Cluster 1 ‚Äì Decipher the Threat</h3>
        <p><b>Problem:</b> You have received an encrypted message from the Space-Based Infrared System, letting you know if the incoming ICBM is a threat or just a test.</p>
        <p><b>Encrypted Message:</b> "WKH LFEP LV QRW D WHVW. LW LV D UHDO WKUHDW."</p>
        <p><b>Hint:</b> "Et tu, Brute?" </p>
        <p>Enter the full decrypted sentence:</p>
        <input id="a1" placeholder="XXX...">
        <button onclick="checkAnswer(1)">Submit</button>
        <p id="code1"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 2 ‚Äì Determine Launch Origin</h3>
        <p><b>Problem:</b> Email the Chinese Diplomatic Agency (chinesediplomat@gmail.com) to see if the ICBM launched from their country. </p>
        <p>They will respond with the source city.</p>
        <p>Enter the ICBM Source City:</p>
        <input id="a2" placeholder="City Name">
        <button onclick="checkAnswer(2)">Submit</button>
        <p id="code2"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 3 ‚Äì Maximum Distance Calculation</h3>
        <p><b>Problem:</b> Your ICBM specialist advisor says the ICBM was most likely launched at 45¬∞ angle above the horizontal. g = 10 m/s¬≤. No air resistance.</p>
        <p>At t = 120s (2 mins), after launch, our satellites have observed the rocket to have a vertical velocity of 5,745 m/s at that instant.</p>
        <p>Find the maximum horizontal distance in miles (round to nearest 100 miles).</p>
        
        <div class="formula-box">
            <i>v<sub>y</sub></i> = <i>v<sub>0y</sub></i> ¬∑ sin(<i>Œ∏</i>) - <i>g</i> ¬∑ <i>t</i><br>
            <i>y</i> = <i>v<sub>0y</sub></i> ¬∑ <i>t</i> - ¬Ω<i>g</i><i>t</i>¬≤<br>
            <i>x</i> = <i>v<sub>0x</sub></i> ¬∑ <i>t<sub>total</sub></i><br>
            <span style="font-size:14px; font-family:'Courier New'">1 mile = 1609 meters</span>
        </div>

        <input id="a3" placeholder="Distance in Miles">
        <button onclick="checkAnswer(3)">Submit</button>
        <p id="code3"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 4 ‚Äì Target City Identification</h3>
        <p><b>Problem:</b> Given the documents provided and the target advisor's intelligence (they sit at the front of Kane 110), determine the most likely target city.</p>
        <p>Enter the city's 3-letter Airport Code:</p>
        <input id="a4" placeholder="XYZ">
        <button onclick="checkAnswer(4)">Submit</button>
        <p id="code4"></p>
    </div>

    <h3>Enter All 4 Authorization Codes</h3>
    <p style="font-size:12px; color:gray;">(Codes are generated above upon solving clusters)</p>
    <input class="launchInput" id="l1">
    <input class="launchInput" id="l2">
    <input class="launchInput" id="l3">
    <input class="launchInput" id="l4">
    <br>
    <button onclick="launchPhase1()">LAUNCH INTERCEPTOR</button>
</div>

<div id="set2" class="section">
    <h2>Phase 2: Emergency Defense Protocol</h2>

    <div class="cluster">
        <h3>Cluster 5 ‚Äì Altitude Logic Puzzle</h3>
        <p><b>Problem:</b>You have gotten 4 bits of information from your engineers tracking the ICBM. You have also found out that two of the engineers are actually spies and are lying (both their statements are false)! This means only 2 of the engineers have factual statements. Given the constraints, determine the missile's altitude in miles. You also know from a secret source that all digits are different.</p>
        <ul>
            <li><b>Alpha:</b> Digits in descending order. Ones is half of tens.</li>
            <li><b>Bravo:</b> Tens digit is 7. All digits sum to 14.</li>
            <li><b>Charlie:</b> All digits even. Ones digit is 8.</li>
            <li><b>Delta:</b> Hundreds odd, ones even. All digits < 6.</li>
        </ul>
        <p>Determine the missile altitude:</p>
        <input id="a5" placeholder="###">
        <button onclick="checkAnswer(5)">Submit</button>
        <p id="code5"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 6 ‚Äì Evacuation Protocol</h3>
        <p><b>Problem:</b> Create a plan to evacuate all personnel from the city and brief it to the GLP administrator. Upon completion, the administrator will provide a password to proceed.</p>
        <p>Enter the Administrator's Password:</p>
        <input id="a6" placeholder="Password">
        <button onclick="checkAnswer(6)">Submit</button>
        <p id="code6"></p>
    </div>

    <div class="cluster">
        <h3>Cluster 7 ‚Äì Vector Collision</h3>
        <p><b>Problem: </b>The Missile Defense Agency has tracked the ICBM and determined its position and velocity vectors. Our GBI has a known starting position and velocity vector.</p>
        <p>ICBM: r = &lt;3000, 2000&gt; m, v = &lt;-150, -100&gt; m/s</p>
        <p>Interceptor: Starts at &lt;0,0&gt;, v = &lt;90, 60&gt; m/s</p>
        <p>Once launched how many seconds until collision?</p>
        
        <div class="formula-box">
            <i>r<sub>rel</sub></i> = <i>r<sub>R</sub></i> - <i>r<sub>I</sub></i><br>
            <i>v<sub>rel</sub></i> = <i>v<sub>R</sub></i> - <i>v<sub>I</sub></i><br>
            <i>r<sub>rel</sub></i> + <i>v<sub>rel</sub></i> ¬∑ <i>t</i> = 0
        </div>

        <input id="a7" placeholder="Seconds">
        <button onclick="checkAnswer(7)">Submit</button>
        <p id="code7"></p>
    </div>

    <h3>Enter All 3 Authorization Codes</h3>
    <input class="launchInput" id="l5">
    <input class="launchInput" id="l6">
    <input class="launchInput" id="l7">
    <br>
    <button onclick="launchPhase2()">FINAL LAUNCH</button>
</div>

<div id="leverStage" class="section" style="text-align: center;">
    <h2 style="color:red; font-size:36px;">MANUAL OVERRIDE REQUIRED</h2>
    <div class="cluster" style="display:inline-block; max-width:800px; text-align:left;">
        <p style="font-size:22px; color:yellow;"><b>CRITICAL ERROR:</b> We forgot the combination of levers to launch the rocket! Figure it out so we can stop the ICBM!</p>
        <p>Adjust the 4 manual relay levers into the correct configuration, then attempt to initiate launch.</p>
        
        <div class="lever-container">
            <button id="lev0" class="lever up" onclick="toggleLever(0)">UP</button>
            <button id="lev1" class="lever up" onclick="toggleLever(1)">UP</button>
            <button id="lev2" class="lever up" onclick="toggleLever(2)">UP</button>
            <button id="lev3" class="lever up" onclick="toggleLever(3)">UP</button>
        </div>

        <div style="text-align: center;">
            <button style="padding: 15px 30px; font-size: 20px;" onclick="checkLevers()">TEST COMBINATION & LAUNCH</button>
        </div>
    </div>
</div>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="gameUI">RADAR TRACKING ACTIVE</div>
</div>
<div id="gameControlsPopup">
    <div class="control-box">
        <h2>INTERCEPTOR CONTROLS</h2>
        <p>USE KEYBOARD TO GUIDE INTERCEPTOR</p>
        <p>
            <span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span>
            <br>OR<br>
            <span class="key">‚Üë</span> <span class="key">‚Üê</span> <span class="key">‚Üì</span> <span class="key">‚Üí</span>
        </p>
        <p style="color:red; margin-top:20px;">INTERCEPT THE HOSTILE TARGET</p>
        <button onclick="startGameEngine()">ENGAGE</button>
    </div>
</div>

<div id="msPopup">
    <div class="control-box" style="border-color: red;">
        <h2 style="color:red;">WARNING: CYBER ATTACK DETECTED</h2>
        <p>The servers are infected with instances of a virus.</p>
        <p style="font-size:18px; line-height:1.4;">
            <b>RULES:</b> Find all instances to restart the server and continue. 
            <br><br>
            - Left-click a sector to scan it.<br>
            - The number reveals how many viruses are in adjacent sectors.<br>
            - Right-click to flag a suspected virus location.<br>
            - Isolate all safe sectors to successfully reboot the system.
        </p>
        <button style="border-color:red; color:red;" onclick="startMinesweeper()">CONTINUE TO SCAN</button>
    </div>
</div>

<div id="msGameContainer">
    <h2 style="color:red; margin-bottom: 20px;">SYSTEM OVERRIDE REQUIRED</h2>
    
    <div id="msGrid" oncontextmenu="return false;"></div>
    <p style="margin-top:10px; color:gray;">Left-Click: Scan Sector | Right-Click: Flag Virus</p>

    <div style="margin-top: 30px; border-top: 2px dashed #00ffcc; padding-top: 20px; text-align: center; max-width: 600px;">
        <p>To proceed, enter the cyber officer's decrypted code, the encrypted code is <b>ORTSGRMTNXJFVVM</b></p>
        
        <div class="formula-box" style="font-family: monospace; font-size: 14px; text-align: left;">
            <b>SUBSTITUTION KEY:</b><br>
            A=Z, B=Y, C=X, D=W, E=V, F=U, G=T, H=S, I=R, J=Q, K=P, L=O, M=N<br>
            N=M, O=L, P=K, Q=J, R=I, S=H, T=G, U=F, V=E, W=D, X=C, Y=B, Z=A
        </div>

        <input id="cyberCodeInput" placeholder="Decrypted Code" style="text-align: center; width: 250px;">
        <button onclick="verifyCyberCode()">VERIFY</button>
        <p id="cyberCodeStatus" style="font-weight:bold; margin-top: 10px;"></p>
    </div>

    <button id="msContinueBtn" style="margin-top: 20px; padding: 15px 30px; font-size: 16px; background: #333; color: #777; border-color: #777; cursor: not-allowed;" disabled onclick="finishCyberAttack()">AWAITING SYSTEM CLEARANCE...</button>

</div>

<div id="popup"></div>
<button id="skipBtn" onclick="skipTime()">‚ö† DO NOT PRESS</button>

<script>
/* --- CORE LOGIC --- */
let time=55*60;
let timer=null;

let answers = {
    1: "THE ICBM IS NOT A TEST. IT IS A REAL THREAT.", 
    2: "PYONGYANG",                                   
    3: "6000",                                        
    4: "SEA",                                         
    5: "542",                                         
    6: "EVACUATE",                                    
    7: "12.5"                                         
};

let staticCodes = {
    1: "8XJ2", 2: "3B9Q", 3: "K4M1", 4: "7D5V", 5: "P2L9", 6: "4X8Z", 7: "W1N6"
};

let codesRevealed = {}; 
let currentPhase = 1;

function beginMission(){
    document.getElementById("start").style.display="none";
    document.getElementById("set1").style.display="block";
    timer=setInterval(updateTimer,1000);
}

// Ensure Cyber Attack doesn't overlap the minigame or full screen transitions
function checkCyberTrigger() {
    if(!document.getElementById("popup")) return;

    if (time <= 44 * 60 && !msTriggered && !gameActive) {
        let p1 = document.getElementById("popup").style.display;
        let p2 = document.getElementById("gameControlsPopup").style.display;
        let start = document.getElementById("start").style.display;
        
        if (p1 !== "flex" && p2 !== "flex" && start === "none") {
            msTriggered = true;
            document.getElementById("msPopup").style.display = "flex";
        }
    }
}

function updateTimer(){
    let m=Math.floor(time/60);
    let s=time%60;
    document.getElementById("time").innerText=
    m.toString().padStart(2,'0')+":"+s.toString().padStart(2,'0');
    
    checkCyberTrigger();

    if(time<=0){
        document.body.innerHTML="<h1 style='color:red;text-align:center;padding-top:200px; position:relative; z-index:9999;'>MISSION FAILURE<br>ITS TOO LATE TO STOP THE ATTACK, USA IS COMPROMISED</h1>";
        clearInterval(timer);
    }
    time--;
}

function checkAnswer(n){
    let val = document.getElementById("a"+n).value.trim().toUpperCase();
    if(n === 1 && val.endsWith('.')) { val = val.slice(0, -1); }
    let isCorrect = false;

    if(val === "DAWG") { isCorrect = true; } 
    else if(n === 1) {
        let cleanInput = val.replace(/[^A-Z]/g, ""); 
        let cleanAnswer = answers[1].replace(/[^A-Z]/g, "");
        if(cleanInput === cleanAnswer) isCorrect = true;
    } else {
        if(val === answers[n]) isCorrect = true;
    }

    if(isCorrect){
        if(!codesRevealed[n]){
            codesRevealed[n] = staticCodes[n]; 
            document.getElementById("code"+n).innerText = "Authorization Code: " + staticCodes[n];
            document.getElementById("code"+n).style.color = "#00ffcc";
        }
    } else {
        alert("INCORRECT ANSWER");
    }
}

function launchPhase1(){
    let v1 = document.getElementById("l1").value.trim().toUpperCase();
    let v2 = document.getElementById("l2").value.trim().toUpperCase();
    let v3 = document.getElementById("l3").value.trim().toUpperCase();
    let v4 = document.getElementById("l4").value.trim().toUpperCase();

    if(
        (v1 === staticCodes[1] || v1 === "DAWG") &&
        (v2 === staticCodes[2] || v2 === "DAWG") &&
        (v3 === staticCodes[3] || v3 === "DAWG") &&
        (v4 === staticCodes[4] || v4 === "DAWG")
    ){
        currentPhase = 1;
        initGameSequence();
    }else{
        alert("INVALID AUTHORIZATION SEQUENCE");
    }
}

function launchPhase2(){
    let v5 = document.getElementById("l5").value.trim().toUpperCase();
    let v6 = document.getElementById("l6").value.trim().toUpperCase();
    let v7 = document.getElementById("l7").value.trim().toUpperCase();

    if(
        (v5 === staticCodes[5] || v5 === "DAWG") &&
        (v6 === staticCodes[6] || v6 === "DAWG") &&
        (v7 === staticCodes[7] || v7 === "DAWG")
    ){
        currentPhase = 2;
        
        if(time > 600) {
            document.getElementById("set2").style.display = "none";
            document.getElementById("leverStage").style.display = "block";
        } else {
            initGameSequence();
        }

    }else{
        alert("INVALID AUTHORIZATION SEQUENCE");
    }
}

/* --- LEVER PUZZLE LOGIC --- */
let levers = [1, 1, 1, 1];

function toggleLever(index) {
    levers[index] = levers[index] === 1 ? 0 : 1;
    let btn = document.getElementById("lev" + index);
    
    if(levers[index] === 1) {
        btn.className = "lever up";
        btn.innerText = "UP";
    } else {
        btn.className = "lever down";
        btn.innerText = "DOWN";
    }
}

function checkLevers() {
    if (levers[0] === 1 && levers[1] === 0 && levers[2] === 0 && levers[3] === 1) {
        document.getElementById("leverStage").style.display = "none";
        initGameSequence();
    } else {
        alert("INCORRECT CONFIGURATION. ROCKET UNRESPONSIVE.");
    }
}

function initGameSequence(){
    let popup=document.getElementById("popup");
    popup.style.display="flex";
    popup.className="flash";
    popup.innerHTML="LAUNCH INITIATED...<br>ACQUIRING TARGET";
    
    setTimeout(()=>{
        popup.style.display="none";
        popup.className="";
        document.getElementById("gameControlsPopup").style.display = "flex";
    }, 2000);
}

function skipTime(){
    time-=300;
    if(time<0) time=0;
    checkCyberTrigger();
}

/* --- MINESWEEPER & CIPHER LOGIC --- */
let msTriggered = false;
let msWon = false;
let codeAccepted = false;
let msData = [];
const msRows = 8;
const msCols = 8;
const msStaticMines = [
    [0, 1], [1, 5], [2, 2], [3, 7], [4, 0],
    [5, 4], [6, 1], [6, 6], [7, 3], [7, 7]
];

function startMinesweeper() {
    document.getElementById("msPopup").style.display = "none";
    document.getElementById("msGameContainer").style.display = "flex";
    initMinesweeper();
}

function initMinesweeper() {
    msWon = false;
    evaluateCyberClear(); 
    msData = [];
    const gridEl = document.getElementById("msGrid");
    gridEl.innerHTML = "";

    for(let r=0; r<msRows; r++) {
        let row = [];
        for(let c=0; c<msCols; c++) {
            row.push({ r: r, c: c, mine: false, revealed: false, flagged: false, adjacent: 0 });
        }
        msData.push(row);
    }

    msStaticMines.forEach(pos => {
        msData[pos[0]][pos[1]].mine = true;
    });

    for(let r=0; r<msRows; r++) {
        for(let c=0; c<msCols; c++) {
            if(msData[r][c].mine) continue;
            let count = 0;
            for(let i=-1; i<=1; i++){
                for(let j=-1; j<=1; j++){
                    let nr = r+i, nc = c+j;
                    if(nr>=0 && nr<msRows && nc>=0 && nc<msCols && msData[nr][nc].mine){
                        count++;
                    }
                }
            }
            msData[r][c].adjacent = count;
        }
    }
    renderMsGrid();
}

function renderMsGrid() {
    const gridEl = document.getElementById("msGrid");
    gridEl.innerHTML = "";
    
    for(let r=0; r<msRows; r++) {
        for(let c=0; c<msCols; c++) {
            let cell = msData[r][c];
            let div = document.createElement("div");
            div.className = "ms-cell";
            
            div.addEventListener("mousedown", (e) => {
                if(e.button === 0) msClick(r, c); 
                if(e.button === 2) msFlag(r, c);  
            });

            if(cell.revealed) {
                div.classList.add("revealed");
                if(cell.mine) {
                    div.classList.add("mine");
                    div.innerText = "üëæ";
                } else if(cell.adjacent > 0) {
                    div.innerText = cell.adjacent;
                    if(cell.adjacent === 1) div.style.color = "#00ffcc";
                    else if(cell.adjacent === 2) div.style.color = "lime";
                    else if(cell.adjacent === 3) div.style.color = "yellow";
                    else div.style.color = "red";
                }
            } else if(cell.flagged) {
                div.innerText = "üö©";
            }
            gridEl.appendChild(div);
        }
    }
}

function msClick(r, c) {
    if(msWon) return; 
    let cell = msData[r][c];
    if(cell.flagged || cell.revealed) return;
    
    cell.revealed = true;
    
    if(cell.mine) {
        renderMsGrid(); 
        setTimeout(() => {
            alert("VIRUS TRIGGERED. REBOOTING SYSTEM...");
            initMinesweeper(); 
        }, 300);
        return;
    }
    
    if(cell.adjacent === 0) {
        for(let i=-1; i<=1; i++){
            for(let j=-1; j<=1; j++){
                let nr = r+i, nc = c+j;
                if(nr>=0 && nr<msRows && nc>=0 && nc<msCols) {
                    if(!msData[nr][nc].revealed) msClick(nr, nc);
                }
            }
        }
    }
    renderMsGrid();
    checkMsWin();
}

function msFlag(r, c) {
    if(msWon) return;
    let cell = msData[r][c];
    if(cell.revealed) return;
    cell.flagged = !cell.flagged;
    renderMsGrid();
}

function checkMsWin() {
    let revealedSafe = 0;
    const totalSafe = (msRows * msCols) - msStaticMines.length;
    
    for(let r=0; r<msRows; r++) {
        for(let c=0; c<msCols; c++) {
            if(msData[r][c].revealed && !msData[r][c].mine) {
                revealedSafe++;
            }
        }
    }
    
    if(revealedSafe === totalSafe && !msWon) {
        msWon = true;
        setTimeout(() => {
            alert("VIRUSES ISOLATED. SERVER CORE STABILIZED.");
            evaluateCyberClear();
        }, 100);
    }
}

function verifyCyberCode() {
    let val = document.getElementById("cyberCodeInput").value.trim().toUpperCase();
    if(val === "LIGHTNINGMCQUEEN" || val === "DAWG") {
        codeAccepted = true;
        document.getElementById("cyberCodeStatus").innerText = "CODE ACCEPTED";
        document.getElementById("cyberCodeStatus").style.color = "lime";
        document.getElementById("cyberCodeInput").disabled = true;
        evaluateCyberClear();
    } else {
        alert("INCORRECT DECRYPTION");
    }
}

function evaluateCyberClear() {
    let btn = document.getElementById("msContinueBtn");
    if(msWon && codeAccepted) {
        btn.disabled = false;
        btn.style.background = "#001f33";
        btn.style.color = "#00ffcc";
        btn.style.borderColor = "#00ffcc";
        btn.style.cursor = "pointer";
        btn.innerText = "ALL CLEAR: RESTART SERVER AND CONTINUE";
    } else {
        btn.disabled = true;
        btn.style.background = "#333";
        btn.style.color = "#777";
        btn.style.borderColor = "#777";
        btn.style.cursor = "not-allowed";
        
        if(msWon) {
            btn.innerText = "AWAITING CYBER CODE...";
        } else if(codeAccepted) {
            btn.innerText = "AWAITING VIRUS ISOLATION...";
        } else {
            btn.innerText = "AWAITING SYSTEM CLEARANCE...";
        }
    }
}

function finishCyberAttack() {
    document.getElementById("msGameContainer").style.display = "none";
    alert("SERVERS RESTARTED SUCCESSFULLY. RESUMING MISSION.");
}

/* --- INTERCEPTOR GAME ENGINE --- */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let gameLoopId;
let icbm = { x: 0, y: 0, vx: 0, vy: 0, g: 0.003 };
let player = { x: 0, y: 0, speed: 5, w: 20, h: 20 };
let explosions = [];
let keys = {};
let gameActive = false;

window.addEventListener('keydown', (e) => { keys[e.key] = true; });
window.addEventListener('keyup', (e) => { keys[e.key] = false; });

function resizeCanvas(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

function startGameEngine(){
    document.getElementById("gameControlsPopup").style.display = "none";
    document.getElementById("gameContainer").style.display = "block";
    resizeCanvas();
    
    player.x = canvas.width / 2;
    player.y = canvas.height - 100;
    
    // Setup ICBM Path to land exactly at bottom right (canvas.width, canvas.height)
    icbm.x = 0;
    icbm.y = canvas.height / 2; 
    let framesToLand = 1000; // Total frames of flight time
    icbm.vx = canvas.width / framesToLand;
    icbm.vy = (canvas.height - (canvas.height / 2) - (0.5 * icbm.g * framesToLand * framesToLand)) / framesToLand;
    
    explosions = [];
    gameActive = true;
    loop();
}

function loop(){
    if(!gameActive) return;

    ctx.fillStyle = "rgba(0, 10, 0, 0.4)"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.strokeStyle = "#003300";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0; i<canvas.width; i+=100){ ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); }
    for(let i=0; i<canvas.height; i+=100){ ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); }
    ctx.stroke();

    if(keys['w'] || keys['ArrowUp']) player.y -= player.speed;
    if(keys['s'] || keys['ArrowDown']) player.y += player.speed;
    if(keys['a'] || keys['ArrowLeft']) player.x -= player.speed;
    if(keys['d'] || keys['ArrowRight']) player.x += player.speed;

    // Strict Padding Limits to keep Player on screen fully
    let padding = 15;
    if(player.x < padding) player.x = padding;
    if(player.x > canvas.width - padding) player.x = canvas.width - padding;
    if(player.y < padding) player.y = padding;
    if(player.y > canvas.height - padding) player.y = canvas.height - padding;

    ctx.fillStyle = "#00ffcc";
    ctx.beginPath();
    ctx.moveTo(player.x, player.y - 10);
    ctx.lineTo(player.x - 10, player.y + 10);
    ctx.lineTo(player.x + 10, player.y + 10);
    ctx.fill();

    icbm.x += icbm.vx;
    icbm.y += icbm.vy;
    icbm.vy += icbm.g; 
    
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.moveTo(icbm.x + 15, icbm.y);
    ctx.lineTo(icbm.x - 5, icbm.y - 5);
    ctx.lineTo(icbm.x - 5, icbm.y + 5);
    ctx.fill();
    ctx.font = "14px Courier";
    ctx.fillStyle = "white";
    ctx.fillText("HOSTILE", icbm.x - 20, icbm.y - 15);

    let dist = Math.hypot(icbm.x - player.x, icbm.y - player.y);
    
    if(dist < 30){
        handleGameEnd(true); 
        return;
    }

    // Boundary check for ICBM hitting screen edges
    if(icbm.x >= canvas.width || icbm.y >= canvas.height){
        icbm.x = Math.min(icbm.x, canvas.width - 15);
        icbm.y = Math.min(icbm.y, canvas.height - 15);
        handleGameEnd(false); 
        return;
    }

    requestAnimationFrame(loop);
}

function handleGameEnd(isHit){
    gameActive = false;
    
    if(isHit){
        ctx.fillStyle = "orange";
        ctx.beginPath();
        ctx.arc(icbm.x, icbm.y, 50, 0, Math.PI*2);
        ctx.fill();
    }

    setTimeout(()=>{
        document.getElementById("gameContainer").style.display = "none";
        
        if(currentPhase === 1){
            let popup = document.getElementById("popup");
            popup.style.display = "flex";
            popup.className = "flash"; 
            
            let msg = isHit ? "LAST MINUTE MALFUNCTION" : "INTERCEPTION FAILED.";
            msg += "<br><br>GBI MISSED TARGET.<br>TIME IS TICKING...";
            
            popup.innerHTML = "<div style='border:2px solid red; padding:20px; background:black;'>" + msg + "</div>";
            
            setTimeout(()=>{
                popup.style.display="none";
                popup.className="";
                document.getElementById("set1").style.display="none";
                document.getElementById("set2").style.display="block";
                checkCyberTrigger(); 
            }, 4000);

        } else if (currentPhase === 2){
            if(isHit){
                document.body.innerHTML="<h1 style='color:lime;text-align:center;padding-top:200px;font-size:50px;'>MISSION SUCCESS<br>THREAT NEUTRALIZED</h1>";
                clearInterval(timer);
            } else {
                alert("MISSED TARGET - RE-ENGAGING TRACKING SYSTEMS");
                startGameEngine();
            }
        }
    }, 500);
}

</script>

</body>
</html>
